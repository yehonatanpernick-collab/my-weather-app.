<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO METEO COMMAND ğŸ›°ï¸</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0b0f19;
            --panel: #151b2b;
            --accent: #3b82f6;
            --text-main: #e2e8f0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Assistant', sans-serif;
            overflow-x: hidden;
        }

        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™× ××§×¦×•×¢×™ */
        .pro-card {
            background-color: var(--panel);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        /* ××¤×ª ×”××›"× */
        #radarMap {
            height: 100%;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }

        /* ××¡×’×¨×ª ×œ××¦×œ××•×ª */
        .cam-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        /* ×× ×™××¦×™×•×ª */
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ×›×¤×ª×•×¨×™ ×˜××‘×™× */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
        }
        .tab-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        /* ×’×œ×™×œ×” ××•×¡×ª×¨×ª */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <header class="flex flex-col md:flex-row gap-4 justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <i class="fas fa-satellite-dish text-blue-500 text-2xl spin-slow"></i>
            <div>
                <h1 class="text-xl font-bold tracking-wider">PRO METEO <span class="text-blue-500">COMMAND</span></h1>
                <div class="text-xs text-gray-400" id="systemStatus">SYSTEM ONLINE â€¢ V.12.0</div>
            </div>
        </div>

        <div class="flex gap-2 w-full md:w-auto">
            <div class="relative flex-1 md:w-64">
                <input type="text" id="searchInput" placeholder="Enter Coordinates / City..." 
                    class="w-full bg-[#1e293b] border border-gray-700 rounded-lg py-2 px-4 focus:outline-none focus:border-blue-500 text-sm">
            </div>
            <button onclick="executeSearch()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-lg font-bold transition">
                SEARCH
            </button>
            <button onclick="locateUser()" class="bg-gray-700 hover:bg-gray-600 px-4 rounded-lg transition">
                <i class="fas fa-location-crosshairs"></i>
            </button>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-1">
        
        <div class="lg:col-span-4 flex flex-col gap-4">
            
            <div class="pro-card p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h2 id="cityName" class="text-3xl font-bold mb-1">--</h2>
                <div id="coords" class="text-xs font-mono text-gray-400 mb-6">LAT: -- | LON: --</div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-6xl font-light text-white"><span id="temp">0</span>Â°</div>
                        <div id="weatherDesc" class="text-blue-300 font-medium mt-1">--</div>
                    </div>
                    <div id="weatherIcon" class="text-6xl opacity-80">ğŸŒ¤ï¸</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="pro-card p-4">
                    <div class="text-gray-400 text-xs mb-1">WIND</div>
                    <div class="text-xl font-bold"><span id="wind">--</span> <small>km/h</small></div>
                    <i class="fas fa-wind text-blue-500/20 absolute bottom-2 left-2 text-3xl"></i>
                </div>
                <div class="pro-card p-4">
                    <div class="text-gray-400 text-xs mb-1">HUMIDITY</div>
                    <div class="text-xl font-bold"><span id="humidity">--</span>%</div>
                    <i class="fas fa-tint text-blue-500/20 absolute bottom-2 left-2 text-3xl"></i>
                </div>
                <div class="pro-card p-4">
                    <div class="text-gray-400 text-xs mb-1">VISIBILITY</div>
                    <div class="text-xl font-bold"><span id="visibility">--</span> <small>km</small></div>
                </div>
                <div class="pro-card p-4">
                    <div class="text-gray-400 text-xs mb-1">UV INDEX</div>
                    <div class="text-xl font-bold" id="uv">--</div>
                </div>
            </div>

            <div class="pro-card p-4 flex-1">
                <h3 class="text-sm font-bold text-gray-400 mb-3 border-b border-gray-700 pb-2">5-DAY FORECAST</h3>
                <div id="forecastList" class="space-y-3 text-sm">
                    </div>
            </div>
        </div>

        <div class="lg:col-span-8 flex flex-col gap-4">
            
            <div class="flex gap-2 bg-[#151b2b] p-2 rounded-lg border border-white/5">
                <button class="tab-btn active" onclick="switchView('radar')" id="btnRadar">
                    <i class="fas fa-layer-group"></i> RADAR & MAP
                </button>
                <button class="tab-btn" onclick="switchView('cams')" id="btnCams">
                    <i class="fas fa-video"></i> LIVE CAMS
                </button>
            </div>

            <div class="pro-card flex-1 relative min-h-[400px] overflow-hidden">
                
                <div id="radarView" class="w-full h-full absolute inset-0">
                    <div id="radarMap"></div>
                    <div class="absolute bottom-4 right-4 bg-black/80 p-2 rounded text-xs z-[1000] border border-white/10">
                        <div class="mb-1">Rain Intensity</div>
                        <div class="w-32 h-2 rounded-full" style="background: linear-gradient(to right, transparent, #00f, #0f0, #ff0, #f00, #f0f);"></div>
                    </div>
                </div>

                <div id="camsView" class="w-full h-full absolute inset-0 hidden bg-black">
                    <iframe id="webcamFrame" class="cam-frame" src=""></iframe>
                    <div id="noCamMsg" class="absolute inset-0 flex items-center justify-center hidden">
                        <div class="text-center">
                            <i class="fas fa-video-slash text-4xl mb-2 text-gray-600"></i>
                            <p>Loading Local Cams...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="loader" class="fixed inset-0 bg-[#0b0f19] z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <div class="mt-4 font-mono text-blue-500 tracking-widest">INITIALIZING SATELLITE...</div>
    </div>

    <script>
        // --- System Core ---
        const system = {
            map: null,
            radarLayer: null,
            currentLat: 32.0853,
            currentLon: 34.7818,
            currentCity: 'Tel Aviv'
        };

        window.onload = () => {
            initMap();
            // ×‘×“×™×§×” ×× ×™×© ×¢×™×¨ ××—×¨×•× ×” ×‘×–×™×›×¨×•×Ÿ
            const lastCity = localStorage.getItem('proMeteoCity');
            if(lastCity) {
                document.getElementById('searchInput').value = lastCity;
                executeSearch();
            } else {
                locateUser();
            }
        };

        // --- View Switching (Radar vs Cams) ---
        function switchView(mode) {
            const radarView = document.getElementById('radarView');
            const camsView = document.getElementById('camsView');
            const btnRadar = document.getElementById('btnRadar');
            const btnCams = document.getElementById('btnCams');

            if (mode === 'radar') {
                radarView.classList.remove('hidden');
                camsView.classList.add('hidden');
                btnRadar.classList.add('active');
                btnCams.classList.remove('active');
                if(system.map) system.map.invalidateSize(); // Fix Leaflet render
            } else {
                radarView.classList.add('hidden');
                camsView.classList.remove('hidden');
                btnRadar.classList.remove('active');
                btnCams.classList.add('active');
                loadWebcams(); // Load cams when tab is clicked
            }
        }

        // --- Data Fetching ---
        async function executeSearch() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            showLoader(true);

            try {
                // Geocoding
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`;
                const geoRes = await fetch(geoUrl).then(r => r.json());
                
                if (!geoRes.results) throw new Error("Target not acquired");
                
                const target = geoRes.results[0];
                system.currentLat = target.latitude;
                system.currentLon = target.longitude;
                system.currentCity = target.name;
                
                localStorage.setItem('proMeteoCity', target.name);

                // Fetch Weather
                await fetchWeatherData(target.latitude, target.longitude);
                
                // Update UI & Map
                updateDashboard(target.name, target.latitude, target.longitude);
                updateMap(target.latitude, target.longitude);
                
                // If cams are open, reload them
                if(!document.getElementById('camsView').classList.contains('hidden')) {
                    loadWebcams();
                }

            } catch (error) {
                alert("SYSTEM ERROR: " + error.message);
            } finally {
                showLoader(false);
            }
        }

        function locateUser() {
            showLoader(true);
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    system.currentLat = pos.coords.latitude;
                    system.currentLon = pos.coords.longitude;
                    system.currentCity = "My Location";
                    fetchWeatherData(pos.coords.latitude, pos.coords.longitude)
                        .then(() => {
                            updateDashboard("My Location", pos.coords.latitude, pos.coords.longitude);
                            updateMap(pos.coords.latitude, pos.coords.longitude);
                            showLoader(false);
                        });
                }, () => { showLoader(false); alert("GPS Signal Lost"); });
            }
        }

        async function fetchWeatherData(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,visibility,is_day&hourly=uv_index&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
            const res = await fetch(url);
            system.weatherData = await res.json();
        }

        // --- UI Updates ---
        function updateDashboard(name, lat, lon) {
            const cur = system.weatherData.current;
            const daily = system.weatherData.daily;

            document.getElementById('cityName').innerText = name;
            document.getElementById('coords').innerText = `LAT: ${lat.toFixed(2)} | LON: ${lon.toFixed(2)}`;
            document.getElementById('temp').innerText = Math.round(cur.temperature_2m);
            document.getElementById('wind').innerText = cur.wind_speed_10m;
            document.getElementById('humidity').innerText = cur.relative_humidity_2m;
            document.getElementById('visibility').innerText = (cur.visibility / 1000).toFixed(1);
            document.getElementById('uv').innerText = system.weatherData.hourly.uv_index[new Date().getHours()] || '-';

            const info = getWeatherInfo(cur.weather_code, cur.is_day);
            document.getElementById('weatherDesc').innerText = info.desc;
            document.getElementById('weatherIcon').innerText = info.icon;

            // Forecast List
            const list = document.getElementById('forecastList');
            list.innerHTML = '';
            for(let i=1; i<6; i++) {
                const dayInfo = getWeatherInfo(daily.weather_code[i], 1);
                const date = new Date(daily.time[i]).toLocaleDateString('en-US', {weekday: 'short', day:'numeric'});
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white/5 p-2 rounded">
                        <div class="w-20 font-mono text-gray-400">${date}</div>
                        <div class="text-xl">${dayInfo.icon}</div>
                        <div class="font-bold">${Math.round(daily.temperature_2m_max[i])}Â° <span class="text-xs font-normal opacity-50">/ ${Math.round(daily.temperature_2m_min[i])}Â°</span></div>
                    </div>
                `;
            }
        }

        // --- Map & Radar Engine ---
        function initMap() {
            // ×™×¦×™×¨×ª ××¤×” ×›×”×”
            system.map = L.map('radarMap', {zoomControl: false}).setView([32, 34], 8);
            
            // ×©×›×‘×ª ×‘×¡×™×¡ ×›×”×” (CartoDB Dark)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 18
            }).addTo(system.map);

            // ×©×›×‘×ª ××›"× ×’×©× (RainViewer)
            // ×˜×™×¤ ××§×¦×•×¢×™: ×× ×—× ×• ××•×¡×™×¤×™× ×©×›×‘×ª ×–××Ÿ ×××ª
            L.tileLayer('https://tile.rainviewer.com/img/radar_nowcast_10min/256/{z}/{x}/{y}/2/1_1.png', {
                opacity: 0.7,
                zIndex: 10
            }).addTo(system.map);
            
            // ×©×›×‘×ª ×¢× × ×™× (OpenWeatherMap - ×—×™× ××™ ×‘×¡×™×¡×™ ××• ×“×•××”)
            // ×›××Ÿ × ×©×ª××© ×‘-RainViewer ×›×™×¡×•×™ ×œ×•×•×™×Ÿ
            L.tileLayer('https://tile.rainviewer.com/img/satellite-drs/256/{z}/{x}/{y}/0/0_0.png', {
                opacity: 0.4
            }).addTo(system.map);
        }

        function updateMap(lat, lon) {
            system.map.flyTo([lat, lon], 9, { animate: true, duration: 1.5 });
            
            // × ×™×§×•×™ ××¨×§×¨×™×
            system.map.eachLayer((layer) => {
                if(layer instanceof L.Marker) system.map.removeLayer(layer);
            });

            // ×”×•×¡×¤×ª ××¨×§×¨ ×¤×•×¢×
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#3b82f6; width:12px; height:12px; border-radius:50%; box-shadow:0 0 10px #3b82f6; border:2px solid white;'></div>",
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });
            
            L.marker([lat, lon], {icon: icon}).addTo(system.map);
        }

        // --- Webcams Integration ---
        function loadWebcams() {
            const frame = document.getElementById('webcamFrame');
            // ×©×™××•×© ×‘-Windy Embed API ×”×•× ×”×“×¨×š ×”×›×™ ×××™× ×” ×œ×§×‘×œ ××¦×œ××•×ª ××›×œ ×”×¢×•×œ× ×‘×—×™× ×
            // ×× ×—× ×• ××›×•×•× ×™× ××ª ×”-iframe ×œ×§×•××•×¨×“×™× ×˜×•×ª ×”× ×•×›×—×™×•×ª
            const lat = system.currentLat;
            const lon = system.currentLon;
            
            // ×›×ª×•×‘×ª URL ×—×›××” ×©××¦×™×’×” ××ª ×©×›×‘×ª ×”××¦×œ××•×ª ×©×œ Windy
            const windyUrl = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=450&zoom=11&level=surface&overlay=cams&product=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1`;
            
            frame.src = windyUrl;
        }

        // --- Utilities ---
        function getWeatherInfo(code, isDay) {
            const codes = {
                0: {d:"Clear Sky", n:"Clear Sky", i:"â˜€ï¸"},
                1: {d:"Mainly Clear", n:"Mainly Clear", i:"ğŸŒ¤ï¸"},
                2: {d:"Partly Cloudy", n:"Partly Cloudy", i:"â›…"},
                3: {d:"Overcast", n:"Overcast", i:"â˜ï¸"},
                45: {d:"Fog", n:"Fog", i:"ğŸŒ«ï¸"},
                51: {d:"Drizzle", n:"Drizzle", i:"ğŸŒ§ï¸"},
                61: {d:"Rain", n:"Rain", i:"â˜”"},
                71: {d:"Snow", n:"Snow", i:"â„ï¸"},
                95: {d:"Thunderstorm", n:"Thunderstorm", i:"â›ˆï¸"}
            };
            const def = codes[code] || codes[0];
            return { desc: def.d, icon: def.i }; // Simplified for Pro look
        }

        function showLoader(show) {
            const el = document.getElementById('loader');
            if(show) { el.classList.remove('opacity-0', 'pointer-events-none'); }
            else { el.classList.add('opacity-0', 'pointer-events-none'); }
        }
    </script>
</body>
</html>
